<div class="container">
  <!-- Header with back navigation -->
  <div class="header">
    <button *ngIf="selectedSurgery" class="back-button" (click)="goBack()">
      <i class="fas fa-arrow-left"></i> Back to Surgeries
    </button>
    <h1 *ngIf="!selectedSurgery">Instruments Outbound Tracking</h1>
    <h1 *ngIf="selectedSurgery">
      {{selectedSurgery.name}} - Room {{selectedSurgery.roomNumber}}
    </h1>
  </div>

  <!-- Loading state -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Loading surgeries...</p>
  </div>

  <!-- Surgery selection screen -->
  <div *ngIf="!loading && !selectedSurgery" class="surgeries-list">
    <div class="list-section">
      <h2>Ongoing Surgeries</h2>
      <div class="no-data" *ngIf="!hasOngoingSurgeries()">
        <p>No ongoing surgeries</p>
      </div>
      <ng-container *ngFor="let surgery of surgeries">
        <div class="surgery-card" *ngIf="isSurgeryOngoing(surgery)" 
             (click)="selectSurgery(surgery)">
          <h3>{{surgery.name}}</h3>
          <div class="surgery-details">
            <p><strong>Room:</strong> {{surgery.roomNumber}}</p>
            <p><strong>Description:</strong> {{surgery.description}}</p>
            <p><strong>Start Time:</strong> {{surgery.scheduledTime | date:'shortTime'}}</p>
            <span class="status in-progress">In Progress</span>
          </div>
        </div>
      </ng-container>
    </div>

    <div class="list-section">
      <h2>Recently Completed Surgeries</h2>
      <div class="no-data" *ngIf="!hasCompletedSurgeries()">
        <p>No completed surgeries</p>
      </div>
      <ng-container *ngFor="let surgery of surgeries">
        <div class="surgery-card" *ngIf="isSurgeryCompleted(surgery)" 
             (click)="selectSurgery(surgery)">
          <h3>{{surgery.name}}</h3>
          <div class="surgery-details">
            <p><strong>Room:</strong> {{surgery.roomNumber}}</p>
            <p><strong>Description:</strong> {{surgery.description}}</p>
            <p><strong>Completion Time:</strong> {{surgery.scheduledTime | date:'shortTime'}}</p>
            <span class="status completed">Completed</span>
          </div>
        </div>
      </ng-container>
    </div>
  </div>

  <!-- Outbound tracking screen -->
  <div *ngIf="!loading && selectedSurgery" class="outbound-tracking">
    <div class="status-card">
      <h2>Post-Operation Room Check</h2>
      <p class="description">
        Scan the operating room to ensure all instruments have been properly removed after the procedure.
      </p>

      <!-- Pre-scan state -->
      <div *ngIf="!scanning && !scanComplete" class="scan-action">
        <button class="primary-button" (click)="startScan()">
          <i class="fas fa-search"></i> Start Room Scan
        </button>
      </div>

      <!-- Scanning in progress -->
      <div *ngIf="scanning" class="scanning-status">
        <div class="spinner"></div>
        <p>Scanning room for remaining instruments...</p>
        <p class="scan-info">Scan duration: 3 seconds</p>
      </div>

      <!-- Scan complete - Room cleared -->
      <div *ngIf="scanComplete && roomCleared" class="scan-result cleared">
        <div class="result-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <h3>Room Cleared</h3>
        <p>No instruments or equipment were found remaining in the operating room.</p>
        <p *ngIf="lastScanTimestamp" class="scan-timestamp">Last scan: {{lastScanTimestamp | date:'medium'}}</p>
        
        <!-- Used items display -->
        <div *ngIf="usedItems && usedItems.length > 0" class="used-items-section">
          <h4>Used Items</h4>
          <p>The following items were used during the procedure:</p>
          <div class="used-items">
            <table>
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Type</th>
                  <th>ID</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of usedItems">
                  <td>{{item.name}}</td>
                  <td>{{item.type | titlecase}}</td>
                  <td>{{item.id || item.unique_id || 'N/A'}}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Scan complete - Items remaining -->
      <div *ngIf="scanComplete && !roomCleared" class="scan-result not-cleared">
        <div class="result-icon">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3>Items Remaining</h3>
        <p>The following items were detected in the operating room:</p>
        
        <!-- Used items display -->
        <div *ngIf="usedItems && usedItems.length > 0" class="used-items-section">
          <h4>Used Items</h4>
          <p>The following items were used during the procedure:</p>
          <div class="used-items">
            <table>
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Type</th>
                  <th>ID</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of usedItems">
                  <td>{{item.name}}</td>
                  <td>{{item.type | titlecase}}</td>
                  <td>{{item.id || item.unique_id || 'N/A'}}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="remaining-items">
          <table>
            <thead>
              <tr>
                <th>Item</th>
                <th>Type</th>
                <th>ID</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of remainingItems">
                <td>{{item.name}}</td>
                <td>{{item.type | titlecase}}</td>
                <td>{{item.id || item.unique_id || 'N/A'}}</td>
                <td>
                  <button class="small-button">Retrieved</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <p *ngIf="lastScanTimestamp" class="scan-timestamp">Last scan: {{lastScanTimestamp | date:'medium'}}</p>

        <div class="actions">
          <button class="primary-button" (click)="markComplete()">
            Mark All Retrieved
          </button>
          <button class="secondary-button" (click)="startScan()">
            Rescan Room
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
