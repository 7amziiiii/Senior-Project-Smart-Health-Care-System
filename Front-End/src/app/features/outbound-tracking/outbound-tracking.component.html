<div class="feature-container">
  <div class="feature-content">
    <!-- Loading state -->
    <div *ngIf="loading" class="loading-container">
      <div class="spinner"></div>
      <p>Loading surgeries...</p>
    </div>

    <!-- If no surgery is selected, show a loading state -->
    <div *ngIf="!loading && !selectedSurgery" class="no-surgery-selected">
      <p>No surgery selected. Returning to dashboard...</p>
      <div class="spinner"></div>
      
      <!-- No surgeries message -->
      <div *ngIf="surgeries.length === 0" class="no-data">
        <p>No surgeries available</p>
      </div>
    </div>

  <!-- Outbound tracking screen with tabs -->
  <div *ngIf="!loading && selectedSurgery" class="verification-container">
    <!-- Streamlined Surgery Header -->
    <div class="surgery-compact-header">
      <div class="surgery-title-area">
        <h3>{{ selectedSurgery.name }}</h3>
        <span class="surgery-meta">
          Room: {{ selectedSurgery.roomNumber }} • 
          {{ selectedSurgery.scheduledTime | date:'MMM d, y • h:mm a' }} • 
          <span [ngClass]="{'status-ongoing': !isSurgeryCompleted(selectedSurgery), 'status-completed': isSurgeryCompleted(selectedSurgery)}">
            {{isSurgeryCompleted(selectedSurgery) ? 'Completed' : 'Ongoing'}}
          </span>
        </span>
      </div>
      <div class="header-actions">
        <span class="last-scan" *ngIf="lastScanTimestamp">
          Last scan: {{ lastScanTimestamp | date:'h:mm a' }}
        </span>
        <button (click)="startScan()" [disabled]="scanning" class="scan-btn">
          <i class="fas fa-sync"></i> Scan
        </button>
      </div>
    </div>

    <!-- Loading indicator -->
    <div *ngIf="scanning" class="loading-indicator">
      <p><i class="fas fa-spinner fa-spin"></i> Scanning room...</p>
    </div>

    <!-- Instrument Status Tabs -->
    <div class="instrument-tabs">
      <div class="tab-headers">
        <div class="tab-header" [class.active]="activeTab === 'remaining'" (click)="activeTab = 'remaining'">
          <i class="fas fa-exclamation-triangle"></i> Remaining Items
          <span class="count-badge">{{remainingInstruments.length + remainingTrays.length}}</span>
        </div>
        <div class="tab-header" [class.active]="activeTab === 'leavet'" (click)="activeTab = 'leavet'">
          <i class="fas fa-check-circle"></i> Retrieved Items
          <span class="count-badge">{{usedItems.length - (remainingInstruments.length + remainingTrays.length)}}</span>
        </div>
        <div class="tab-header" [class.active]="activeTab === 'allreq'" (click)="activeTab = 'allreq'">
          <i class="fas fa-clipboard-list"></i> All Required Items
          <span class="count-badge">{{usedItems.length}}</span>
        </div>
      </div>

    <!-- Tab Content Area -->  
    <!-- Remaining Items Tab Content -->  
    <div class="tab-content" *ngIf="activeTab === 'remaining'">
      <div class="alert-panel" *ngIf="remainingInstruments.length + remainingTrays.length > 0">
        <div class="alert-header">
          <i class="fas fa-exclamation-triangle"></i>
          <span>Attention Required</span>
        </div>
        <p>These items were used in the surgery and are still present in the operating room</p>
      </div>
            
      <!-- Remaining Instruments -->  
      <div class="instruments-table-container" *ngIf="remainingInstruments.length > 0">
        <h4>Remaining Instruments</h4>
        <table class="instruments-table">
          <thead>
            <tr>
              <th>Item Name</th>
              <th>Type</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of remainingInstruments" class="warning-row">
              <td>{{item.name}}</td>
              <td>Instrument</td>
              <td>
                <span class="status-tag warning">Remaining</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
        
      <!-- Remaining Trays -->  
      <div class="instruments-table-container" *ngIf="remainingTrays.length > 0">
        <h4>Remaining Trays</h4>
        <table class="instruments-table">
          <thead>
            <tr>
              <th>Item Name</th>
              <th>Type</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of remainingTrays" class="warning-row">
              <td>{{item.name}}</td>
              <td>Tray</td>
              <td>
                <span class="status-tag warning">Remaining</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
          
      <!-- Extra Items Section -->  
      <div *ngIf="extraInstruments.length > 0 || extraTrays.length > 0">
        <h4 class="section-title">Extra Items (Not Used in Surgery)</h4>
        <p class="section-description">These items were not used in the surgery but are present in the room</p>
            
        <!-- Extra Instruments -->  
        <div class="instruments-table-container" *ngIf="extraInstruments.length > 0">
          <table class="instruments-table">
            <thead>
              <tr>
                <th>Item Name</th>
                <th>Type</th>
                <th>Quantity</th>
                <th>IDs</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of extraInstruments" class="extra-row">
                <td>{{item.name}}</td>
                <td>Instrument</td>
                <td class="quantity-cell">{{item.quantity}}</td>
                <td>
                  <span class="id-chip" *ngFor="let id of item.ids">{{id}}</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
          
        <!-- Extra Trays -->  
        <div class="instruments-table-container" *ngIf="extraTrays.length > 0">
          <table class="instruments-table">
            <thead>
              <tr>
                <th>Item Name</th>
                <th>Type</th>
                <th>Quantity</th>
                <th>IDs</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of extraTrays" class="extra-row">
                <td>{{item.name}}</td>
                <td>Tray</td>
                <td class="quantity-cell">{{item.quantity}}</td>
                <td>
                  <span class="id-chip" *ngFor="let id of item.ids">{{id}}</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
        
      <!-- No items message -->  
      <div class="empty-message" *ngIf="remainingInstruments.length === 0 && remainingTrays.length === 0 && extraInstruments.length === 0 && extraTrays.length === 0">
        <i class="fas fa-check-circle success-icon"></i>
        <p>No items remaining in the room. All items have been retrieved.</p>
      </div>
    </div>
        
    <!-- Retrieved Items Tab Content -->  
    <div class="tab-content" *ngIf="activeTab === 'leavet'">
      <div class="instruments-table-container">
        <table class="instruments-table">
          <thead>
            <tr>
              <th>Item Name</th>
              <th>Type</th>
              <th>Quantity</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="(usedItems.length - (remainingInstruments.length + remainingTrays.length)) === 0" class="no-data-row">
              <td colspan="4" class="no-data-cell">
                <i class="fas fa-info-circle"></i> No items have been retrieved yet
              </td>
            </tr>
            <tr *ngFor="let item of usedItems" class="success-row" 
                [hidden]="isItemRemaining(item.name, item.type)">
              <td>{{item.name}}</td>
              <td>{{item.type | titlecase}}</td>
              <td class="quantity-cell">{{item.quantity}}</td>
              <td>
                <span class="status-tag success">
                  <i class="fas fa-check-circle"></i> Retrieved
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
        
    <!-- All Required Items Tab Content -->  
    <div class="tab-content" *ngIf="activeTab === 'allreq'">
      <div class="instruments-table-container">
        <table class="instruments-table">
          <thead>
            <tr>
              <th>Item Name</th>
              <th>Type</th>
              <th>Quantity</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="usedItems.length === 0" class="no-data-row">
              <td colspan="4" class="no-data-cell">
                <i class="fas fa-info-circle"></i> No items registered for this surgery
              </td>
            </tr>
            <tr *ngFor="let item of usedItems"
                [ngClass]="{'warning-row': isItemRemaining(item.name, item.type), 'success-row': !isItemRemaining(item.name, item.type)}">
              <td>{{item.name}}</td>
              <td>{{item.type | titlecase}}</td>
              <td class="quantity-cell">{{item.quantity}}</td>
              <td>
                <span *ngIf="!isItemRemaining(item.name, item.type)" class="status-tag success">
                  <i class="fas fa-check-circle"></i> Retrieved
                </span>
                <span *ngIf="isItemRemaining(item.name, item.type)" class="status-tag warning">
                  <i class="fas fa-exclamation-circle"></i> Remaining
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Action buttons at the bottom -->  
    <div class="action-bar">
      <div class="action-buttons">
        <button class="action-btn primary" (click)="markComplete()" [disabled]="remainingInstruments.length === 0 && remainingTrays.length === 0">
          <i class="fas fa-check-double"></i> Mark All Retrieved
        </button>
        <button class="action-btn secondary" (click)="startScan()" [disabled]="scanning">
          <i class="fas fa-sync"></i> Rescan Room
        </button>
      </div>
    </div>
  </div>
  </div>
</div>
