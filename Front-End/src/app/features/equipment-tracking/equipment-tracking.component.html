<div class="feature-container">
  <div class="container">
  <div class="feature-header">
    <div class="header-content">
      <button (click)="goBack()" class="back-button">
        <i class="fas fa-arrow-left"></i> Back
      </button>
      <h1>Large Equipment for {{ surgeryName }}</h1>
    </div>
    <div class="status-bar">
      <div class="breadcrumbs">
        <span>Dashboard</span> &gt; 
        <span>{{ surgeryName }}</span> &gt; 
        <span class="current">Large Equipment</span>
      </div>
    </div>
  </div>

  <div class="equipment-container" *ngIf="!loading; else loadingTemplate">
    <div *ngIf="errorMessage" class="error-message">
      <i class="fas fa-exclamation-triangle"></i> {{ errorMessage }}
    </div>
    
    <div *ngIf="requestSent" class="success-message">
      <i class="fas fa-check-circle"></i> Equipment request sent successfully to maintenance team!
    </div>

    <div class="summary-stats">
      <div class="stat-card">
        <div class="stat-title">Total Equipment</div>
        <div class="stat-value">{{ equipmentList.length }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Available</div>
        <div class="stat-value">{{ availableEquipmentCount }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Missing</div>
        <div class="stat-value">{{ missingEquipmentCount }}</div>
      </div>
    </div>

    <!-- Hidden information about scanning status -->
    <div style="display: none;">
      <span *ngIf="roomScanInProgress">Scanning in progress</span>
      <span *ngIf="!roomScanInProgress && roomScanComplete">Scan Complete</span>
      <div *ngIf="lastScanTime">Last scan: {{ lastScanTime | date:'medium' }}</div>
      <div *ngIf="roomId">Room ID: {{ roomId }}</div>
    </div>
    
    <div class="equipment-table-container">
      <!-- Equipment in the room -->
      <div class="equipment-section">
        <h2>Equipment In The Room</h2>
        <div *ngIf="inRoomEquipment.length > 0; else noInRoomEquipment">
          <table class="equipment-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>ID</th>
                <th>Type</th>
                <th>Location</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of inRoomEquipment" [class.missing]="!item.isAvailable">
                <td>{{ item.equipment.name }}</td>
                <td>{{ item.equipment.equipment_id }}</td>
                <td>{{ item.equipment.equipment_type }}</td>
                <td>{{ item.equipment.location || 'Unknown' }}</td>
                <td [class.status-available]="item.isAvailable || item.requestStatus === 'approved'" 
                    [class.status-missing]="!item.isAvailable && item.requestStatus !== 'approved'" 
                    [class.status-approved]="item.requestStatus === 'approved'">
                  <ng-container *ngIf="item.requestStatus === 'approved'">Approved</ng-container>
                  <ng-container *ngIf="item.requestStatus !== 'approved'">{{ item.isAvailable ? 'Available' : 'Missing' }}</ng-container>
                </td>
                <td>
                  <button 
                    class="request-btn" 
                    (click)="requestEquipment(item.equipment)"
                    [disabled]="requestInProgress || item.equipment.status === 'in_use' || item.requestStatus"
                    [ngClass]="{
                      'requested-btn': item.requestStatus === 'requested',
                      'accepted-btn': item.requestStatus === 'approved',
                      'rejected-btn': item.requestStatus === 'rejected',
                      'in-use-btn': item.requestStatus === 'in_use',
                      'returned-btn': item.requestStatus === 'returned',
                      'maintenance-btn': item.requestStatus === 'maintenance'
                    }"
                  >
                    <ng-container *ngIf="!item.requestStatus">
                      <i class="fas fa-plus-circle"></i> Request
                    </ng-container>
                    <ng-container *ngIf="item.requestStatus === 'requested'">
                      <i class="fas fa-clock"></i> Requested
                    </ng-container>
                    <ng-container *ngIf="item.requestStatus === 'approved'">
                      <i class="fas fa-check-circle"></i> Approved
                    </ng-container>
                    <ng-container *ngIf="item.requestStatus === 'rejected'">
                      <i class="fas fa-times-circle"></i> Rejected
                    </ng-container>
                    <ng-container *ngIf="item.requestStatus === 'in_use'">
                      <i class="fas fa-spinner fa-spin"></i> In Use
                    </ng-container>
                    <ng-container *ngIf="item.requestStatus === 'returned'">
                      <i class="fas fa-undo"></i> Returned
                    </ng-container>
                    <ng-container *ngIf="item.requestStatus === 'maintenance'">
                      <i class="fas fa-tools"></i> Maintenance
                    </ng-container>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <ng-template #noInRoomEquipment>
          <div class="no-data-message">No equipment in this room</div>
        </ng-template>
      </div>
      
      <!-- Normal equipment list -->
      <div class="equipment-section">
        <h2>Other Required Equipment</h2>
        <div *ngIf="normalEquipment.length > 0; else noNormalEquipment">
          <table class="equipment-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>ID</th>
                <th>Type</th>
                <th>Location</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of normalEquipment" [class.missing]="!item.isAvailable">
                <td>{{ item.equipment.name }}</td>
                <td>{{ item.equipment.equipment_id }}</td>
                <td>{{ item.equipment.equipment_type }}</td>
                <td>{{ item.equipment.location || 'Unknown' }}</td>
                <td [class.status-available]="item.isAvailable || item.requestStatus === 'approved'" 
                    [class.status-missing]="!item.isAvailable && item.requestStatus !== 'approved'" 
                    [class.status-approved]="item.requestStatus === 'approved'">
                  <ng-container *ngIf="item.requestStatus === 'approved'">Approved</ng-container>
                  <ng-container *ngIf="item.requestStatus !== 'approved'">{{ item.isAvailable ? 'Available' : 'Missing' }}</ng-container>
                </td>
                <td>
                  <button 
                    class="request-btn" 
                    (click)="requestEquipment(item.equipment)"
                    [disabled]="requestInProgress || item.equipment.status === 'in_use' || item.requestStatus"
                    [ngClass]="{
                      'requested-btn': item.requestStatus === 'requested',
                      'accepted-btn': item.requestStatus === 'approved',
                      'rejected-btn': item.requestStatus === 'rejected',
                      'in-use-btn': item.requestStatus === 'in_use',
                      'returned-btn': item.requestStatus === 'returned',
                      'maintenance-btn': item.requestStatus === 'maintenance'
                    }"
                  >
                    <ng-container *ngIf="!item.requestStatus">
                      <i class="fas fa-plus-circle"></i> Request
                    </ng-container>
                    <ng-container *ngIf="item.requestStatus === 'requested'">
                      <i class="fas fa-clock"></i> Requested
                    </ng-container>
                    <ng-container *ngIf="item.requestStatus === 'approved'">
                      <i class="fas fa-check-circle"></i> Approved
                    </ng-container>
                    <ng-container *ngIf="item.requestStatus === 'rejected'">
                      <i class="fas fa-times-circle"></i> Rejected
                    </ng-container>
                    <ng-container *ngIf="item.requestStatus === 'in_use'">
                      <i class="fas fa-spinner fa-spin"></i> In Use
                    </ng-container>
                    <ng-container *ngIf="item.requestStatus === 'returned'">
                      <i class="fas fa-undo"></i> Returned
                    </ng-container>
                    <ng-container *ngIf="item.requestStatus === 'maintenance'">
                      <i class="fas fa-tools"></i> Maintenance
                    </ng-container>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <ng-template #noNormalEquipment>
          <div class="no-data-message">No other equipment required for this surgery</div>
        </ng-template>
      </div>
      
      <!-- Show if no equipment at all -->
      <div *ngIf="equipmentList.length === 0" class="no-data-message">
        No equipment required for this surgery
      </div>
    </div>
  </div>

  <ng-template #loadingTemplate>
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p>Loading equipment data...</p>
    </div>
  </ng-template>
</div>
