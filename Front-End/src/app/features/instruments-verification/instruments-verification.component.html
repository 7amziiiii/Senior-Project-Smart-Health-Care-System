<div class="feature-container">
  <div class="feature-header">
    <div class="title-area">
      <div class="page-title">
        <span class="feature-icon"><i class="fas fa-clipboard-check"></i></span>
        <h1>Instruments Verification</h1>
      </div>
    </div>
    <div class="button-group">
      <button class="btn btn-primary back-btn" (click)="backToFeatures()">
        <i class="fas fa-arrow-left"></i> Back to Features
      </button>
    </div>
  </div>
  
  <div class="feature-content">
    <div class="container">
      <div *ngIf="!selectedSurgery" class="surgery-selection">
        <h3>Select a Surgery</h3>
        <div class="surgery-list">
          <div *ngFor="let surgery of surgeries" 
              class="surgery-card" 
              [class.ongoing]="surgery.status === 'ongoing'" 
              [class.scheduled]="surgery.status === 'scheduled'"
              (click)="selectSurgery(surgery)">
            <h4>{{ surgery.name }}</h4>
            <p>{{ surgery.scheduledTime | date:'medium' }}</p>
            <p>Status: <span [ngClass]="{'ongoing-status': surgery.status === 'ongoing', 'scheduled-status': surgery.status === 'scheduled'}">{{ surgery.status }}</span></p>
          </div>
        </div>
      </div>

      <div *ngIf="selectedSurgery" class="verification-container">
        <!-- Streamlined Surgery Header -->
        <div class="surgery-compact-header">
          <div class="surgery-title-area">
            <h3>{{ selectedSurgery.name }}</h3>
            <span class="surgery-meta">
              {{ selectedSurgery.scheduledTime | date:'MMM d, y • h:mm a' }} • 
              <span [ngClass]="{'status-ongoing': selectedSurgery.status === 'ongoing', 'status-scheduled': selectedSurgery.status === 'scheduled'}">{{ selectedSurgery.status | titlecase }}</span>
            </span>
          </div>
          <div class="header-actions">
            <span class="last-scan" *ngIf="verificationStatus">
              Last scan: {{ verificationStatus.last_updated | date:'h:mm a' }}
            </span>
            <button (click)="forceVerificationScan()" class="scan-btn">
              <i class="fas fa-sync"></i> Scan
            </button>
          </div>
        </div>

        <!-- Loading indicator -->
        <div *ngIf="isVerifying && !verificationStatus" class="loading-indicator">
          <p><i class="fas fa-spinner fa-spin"></i> Starting verification...</p>
        </div>

        <!-- Instrument Status Tabs -->
        <div class="instrument-tabs" *ngIf="selectedSurgery && verificationStatus">
          <div class="tab-headers">
            <div class="tab-header" [class.active]="activeTab === 'missing'" (click)="activeTab = 'missing'">
              <i class="fas fa-exclamation-triangle"></i> Missing Items
              <span class="count-badge">{{ getItemsCount('missing', 'instruments') + getItemsCount('missing', 'trays') }}</span>
            </div>
            <div class="tab-header" [class.active]="activeTab === 'present'" (click)="activeTab = 'present'">
              <i class="fas fa-check"></i> Present Items
              <span class="count-badge">{{ getItemsCount('used', 'instruments') + getItemsCount('used', 'trays') }}</span>
            </div>
            <div class="tab-header" [class.active]="activeTab === 'extra'" (click)="activeTab = 'extra'">
              <i class="fas fa-plus-circle"></i> Extra Items
              <span class="count-badge">{{ getItemsCount('extra', 'instruments') + getItemsCount('extra', 'trays') }}</span>
            </div>
            <div class="tab-header" [class.active]="activeTab === 'all'" (click)="activeTab = 'all'">
              <i class="fas fa-list"></i> All Required
              <span class="count-badge">{{ getTotalRequiredItems() }}</span>
            </div>
          </div>
          
          <!-- Missing Items Tab Content -->
          <div class="tab-content" *ngIf="activeTab === 'missing'">
            <div class="instruments-table-container">
              <table class="instruments-table">
                <thead>
                  <tr>
                    <th>Item Name</th>
                    <th>Type</th>
                    <th>Quantity</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngIf="!hasCombinedItems('missing')">
                    <td colspan="3" class="no-data-cell">
                      <i class="fas fa-check-circle"></i> All required items are present
                    </td>
                  </tr>
                  <tr *ngFor="let item of getCombinedItems('missing')" class="missing-row">
                    <td>{{ item.name }}</td>
                    <td>{{ item.type === 'tray' ? 'Tray' : 'Instrument' }}</td>
                    <td class="quantity-cell">
                      <strong>{{ item.quantity }}</strong>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- Present Items Tab Content -->
          <div class="tab-content" *ngIf="activeTab === 'present'">
            <div class="instruments-table-container">
              <table class="instruments-table">
                <thead>
                  <tr>
                    <th>Item Name</th>
                    <th>Type</th>
                    <th>Quantity</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngIf="!hasCombinedItems('used')">
                    <td colspan="3" class="no-data-cell">
                      <i class="fas fa-exclamation-triangle"></i> No items detected in room
                    </td>
                  </tr>
                  <tr *ngFor="let item of getCombinedItems('used')" class="present-row">
                    <td>{{ item.name }}</td>
                    <td>{{ item.type === 'tray' ? 'Tray' : 'Instrument' }}</td>
                    <td class="quantity-cell">
                      <strong>{{ item.quantity }}</strong>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- Extra Items Tab Content -->
          <div class="tab-content" *ngIf="activeTab === 'extra'">
            <div class="instruments-table-container">
              <table class="instruments-table">
                <thead>
                  <tr>
                    <th>Item Name</th>
                    <th>Type</th>
                    <th>Quantity</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngIf="!hasCombinedItems('extra')">
                    <td colspan="3" class="no-data-cell">
                      <i class="fas fa-check-circle"></i> No unexpected items detected
                    </td>
                  </tr>
                  <tr *ngFor="let item of getCombinedItems('extra')" class="extra-row">
                    <td>{{ item.name }}</td>
                    <td>{{ item.type === 'tray' ? 'Tray' : 'Instrument' }}</td>
                    <td class="quantity-cell">
                      <strong>{{ item.quantity }}</strong>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- All Required Tab Content -->
          <div class="tab-content" *ngIf="activeTab === 'all'">
            <div class="instruments-table-container">
              <table class="instruments-table">
                <thead>
                  <tr>
                    <th>Item Name</th>
                    <th>Type</th>
                    <th>Quantity</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngIf="!verificationStatus?.required_items">
                    <td colspan="4" class="no-data-cell">
                      <i class="fas fa-info-circle"></i> No required items defined for this operation
                    </td>
                  </tr>
                  <tr *ngFor="let item of getCombinedItems('required')" 
                      [ngClass]="{'present-row': !isItemMissing(item.name), 'missing-row': isItemMissing(item.name)}">
                    <td>{{ item.name }}</td>
                    <td>{{ item.type === 'tray' ? 'Tray' : 'Instrument' }}</td>
                    <td class="quantity-cell">
                      <strong>{{ item.quantity }}</strong>
                    </td>
                    <td class="status-cell">
                      <span *ngIf="!isItemMissing(item.name)" class="status-indicator present">
                        <i class="fas fa-check-circle"></i> Present
                      </span>
                      <span *ngIf="isItemMissing(item.name)" class="status-indicator missing">
                        <i class="fas fa-times-circle"></i> Missing
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
