<div class="feature-container">
  <div class="feature-header">
    <div class="title-area">
      <div class="page-title">
        <span class="feature-icon"><i class="fas fa-clipboard-check"></i></span>
        <h1>Instruments Verification</h1>
      </div>
      <p class="breadcrumb">
        <a [routerLink]="['/dashboard']" class="back-link"><i class="fas fa-angle-left"></i> Back to Dashboard</a>
      </p>
    </div>
    <div class="button-group">
      <button class="btn btn-secondary" routerLink="/dashboard">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </button>
    </div>
  </div>
  
  <div class="feature-content">
    <div class="container">
      <div *ngIf="!selectedSurgery" class="surgery-selection">
        <h3>Select a Surgery</h3>
        <div class="surgery-list">
          <div *ngFor="let surgery of surgeries" 
              class="surgery-card" 
              [class.ongoing]="surgery.status === 'ongoing'" 
              [class.scheduled]="surgery.status === 'scheduled'"
              (click)="selectSurgery(surgery)">
            <h4>{{ surgery.name }}</h4>
            <p>{{ surgery.scheduledTime | date:'medium' }}</p>
            <p>Status: <span [ngClass]="{'ongoing-status': surgery.status === 'ongoing', 'scheduled-status': surgery.status === 'scheduled'}">{{ surgery.status }}</span></p>
          </div>
        </div>
      </div>

      <div *ngIf="selectedSurgery" class="verification-container">
        <!-- Streamlined Surgery Header -->
        <div class="surgery-compact-header">
          <div class="surgery-title-area">
            <h3>{{ selectedSurgery.name }}</h3>
            <span class="surgery-meta">
              {{ selectedSurgery.scheduledTime | date:'MMM d, y • h:mm a' }} • 
              <span [ngClass]="{'status-ongoing': selectedSurgery.status === 'ongoing', 'status-scheduled': selectedSurgery.status === 'scheduled'}">{{ selectedSurgery.status | titlecase }}</span>
            </span>
          </div>
          <div class="header-actions">
            <span class="last-scan" *ngIf="verificationStatus">
              Last scan: {{ verificationStatus.last_updated | date:'h:mm a' }}
            </span>
            <button (click)="forceVerificationScan()" class="scan-btn">
              <i class="fas fa-sync"></i> Scan
            </button>
            <button (click)="selectSurgery(null)" class="back-btn">
              <i class="fas fa-angle-left"></i> Back
            </button>
          </div>
        </div>

        <!-- Loading indicator -->
        <div *ngIf="isVerifying && !verificationStatus" class="loading-indicator">
          <p><i class="fas fa-spinner fa-spin"></i> Starting verification...</p>
        </div>

        <!-- Instrument Status Tabs -->
        <div class="instrument-tabs" *ngIf="selectedSurgery && verificationStatus">
          <div class="tab-headers">
            <div class="tab-header" [class.active]="activeTab === 'missing'" (click)="activeTab = 'missing'">
              <i class="fas fa-exclamation-triangle"></i> Missing Instruments
              <span class="count-badge">{{ getItemsCount('missing', 'instruments') }}</span>
            </div>
            <div class="tab-header" [class.active]="activeTab === 'present'" (click)="activeTab = 'present'">
              <i class="fas fa-check"></i> Present Instruments
              <span class="count-badge">{{ getItemsCount('used', 'instruments') }}</span>
            </div>
            <div class="tab-header" [class.active]="activeTab === 'extra'" (click)="activeTab = 'extra'">
              <i class="fas fa-plus-circle"></i> Extra Instruments
              <span class="count-badge">{{ getItemsCount('extra', 'instruments') }}</span>
            </div>
            <div class="tab-header" [class.active]="activeTab === 'all'" (click)="activeTab = 'all'">
              <i class="fas fa-list"></i> All Required
              <span class="count-badge">{{ selectedSurgery.requiredInstruments.length }}</span>
            </div>
          </div>
          
          <!-- Missing Instruments Tab Content -->
          <div class="tab-content" *ngIf="activeTab === 'missing'">
            <div class="instruments-table-container">
              <table class="instruments-table">
                <thead>
                  <tr>
                    <th>RFID Tag</th>
                    <th>Instrument Name</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let instrument of getInstrumentsNotInRoom()" class="missing-row">
                    <td class="tag-id">{{ instrument.id }}</td>
                    <td>{{ instrument.name }}</td>
                    <td class="status-cell">
                      <span class="status-indicator missing">
                        <i class="fas fa-times-circle"></i> Missing
                      </span>
                    </td>
                  </tr>
                  <tr *ngIf="getInstrumentsNotInRoom().length === 0">
                    <td colspan="3" class="no-data-cell">
                      <i class="fas fa-check-circle"></i> All instruments are present
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- Present Instruments Tab Content -->
          <div class="tab-content" *ngIf="activeTab === 'present'">
            <div class="instruments-table-container">
              <table class="instruments-table">
                <thead>
                  <tr>
                    <th>RFID Tag</th>
                    <th>Instrument Name</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let instrument of getInstrumentsInRoom()" class="present-row">
                    <td class="tag-id">{{ instrument.id }}</td>
                    <td>{{ instrument.name }}</td>
                    <td class="status-cell">
                      <span class="status-indicator present">
                        <i class="fas fa-check-circle"></i> Present
                      </span>
                    </td>
                  </tr>
                  <tr *ngIf="getInstrumentsInRoom().length === 0">
                    <td colspan="3" class="no-data-cell">
                      <i class="fas fa-exclamation-triangle"></i> No instruments detected in room
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- Extra Instruments Tab Content -->
          <div class="tab-content" *ngIf="activeTab === 'extra'">
            <div class="instruments-table-container">
              <table class="instruments-table">
                <thead>
                  <tr>
                    <th>RFID Tag</th>
                    <th>Instrument Name</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- This is a placeholder. In the real implementation, this would show unexpected instruments in the room -->
                  <tr *ngIf="getItemsCount('extra', 'instruments') === 0">
                    <td colspan="3" class="no-data-cell">
                      <i class="fas fa-check-circle"></i> No unexpected instruments detected
                    </td>
                  </tr>
                  <!-- Placeholder for extra instruments (will be populated from real data) -->
                  <tr *ngFor="let i of [1,2,3].slice(0, getItemsCount('extra', 'instruments'))" class="extra-row">
                    <td class="tag-id">E-{{ 500 + i }}</td>
                    <td>Unknown Instrument {{ i }}</td>
                    <td class="status-cell">
                      <span class="status-indicator extra">
                        <i class="fas fa-plus-circle"></i> Unexpected
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- All Required Instruments Tab Content -->
          <div class="tab-content" *ngIf="activeTab === 'all'">
            <div class="instruments-table-container">
              <table class="instruments-table">
                <thead>
                  <tr>
                    <th>RFID Tag</th>
                    <th>Instrument Name</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let instrument of selectedSurgery.requiredInstruments" 
                      [ngClass]="{'present-row': instrument.inRoom, 'missing-row': !instrument.inRoom}">
                    <td class="tag-id">{{ instrument.id }}</td>
                    <td>{{ instrument.name }}</td>
                    <td class="status-cell">
                      <span *ngIf="instrument.inRoom" class="status-indicator present">
                        <i class="fas fa-check-circle"></i> Present
                      </span>
                      <span *ngIf="!instrument.inRoom" class="status-indicator missing">
                        <i class="fas fa-times-circle"></i> Missing
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
