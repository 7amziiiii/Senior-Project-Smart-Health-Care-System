<div class="admin-container">
  <div class="admin-header">
    <h1><i class="fas fa-hospital-user"></i> Admin Dashboard</h1>
  </div>

  <!-- Admin Options (main navigation) -->
  <div class="admin-options" *ngIf="!showApprovalPanel && !showDashboard && !showInstruments">
    <div class="option-card" (click)="navigateToPanel('approval')">
      <h2><i class="fas fa-user-check"></i> User Management</h2>
      <div class="option-content">
        <p>Review and approve user registrations</p>
        <div class="card-footer">
          <span class="action-hint">Manage approvals <i class="fas fa-arrow-right"></i></span>
        </div>
      </div>
    </div>
    
    <div class="option-card" (click)="navigateToPanel('dashboard')">
      <h2><i class="fas fa-procedures"></i> OR Dashboard</h2>
      <div class="option-content">
        <p>Monitor surgeries and operating room activity</p>
        <div class="card-footer">
          <span class="action-hint">View dashboard <i class="fas fa-arrow-right"></i></span>
        </div>
      </div>
    </div>
    
    <div class="option-card" (click)="navigateToPanel('instruments')">
      <h2><i class="fas fa-briefcase-medical"></i> Asset Management</h2>
      <div class="option-content">
        <p>Register and manage instruments, trays, and large equipment with RFID tracking</p>
        <div class="card-footer">
          <span class="action-hint">Manage assets <i class="fas fa-arrow-right"></i></span>
        </div>
      </div>
    </div>
    
    <div class="option-card" (click)="navigateToPanel('maintenance')">
      <h2><i class="fas fa-tools"></i> Maintenance Dashboard</h2>
      <div class="option-content">
        <p>Access maintenance tools and equipment monitoring</p>
        <div class="card-footer">
          <span class="action-hint">View maintenance <i class="fas fa-arrow-right"></i></span>
        </div>
      </div>
    </div>
    
    <div class="option-card" (click)="navigateToPanel('logs')">
      <h2><i class="fas fa-clipboard-list"></i> System Logs</h2>
      <div class="option-content">
        <p>View verification logs, outbound tracking logs, and system activity</p>
        <div class="card-footer">
          <span class="action-hint">View logs <i class="fas fa-arrow-right"></i></span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- User Approval Panel -->
  <div class="panel-container" *ngIf="showApprovalPanel">
    <div class="panel-header">
      <button class="back-btn" (click)="backToMainMenu()"><i class="fas fa-arrow-left"></i> Back</button>
      <h2><i class="fas fa-user-check"></i> User Registration Approval</h2>
    </div>
    
    <div class="approval-section">
      <div *ngIf="loading" class="loading">
        <p>Loading pending users...</p>
      </div>

      <div *ngIf="error" class="error-message">
        <p>{{ error }}</p>
        <button (click)="loadPendingUsers()">Retry</button>
      </div>

      <div *ngIf="successMessage" class="success-message">
        <p>{{ successMessage }}</p>
      </div>

      <div *ngIf="!loading && pendingUsers.length === 0 && !error" class="empty-state">
        <p>No pending user registrations found.</p>
      </div>

      <table *ngIf="!loading && pendingUsers.length > 0" class="users-table">
        <thead>
          <tr>
            <th>Username</th>
            <th>Full Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Date Joined</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of pendingUsers">
            <td>{{ user.username }}</td>
            <td>{{ user.first_name }} {{ user.last_name }}</td>
            <td>{{ user.email }}</td>
            <td>{{ user.role }}</td>
            <td>{{ user.date_joined | date:'medium' }}</td>
            <td>
              <button 
                [disabled]="processingUsers[user.id]" 
                (click)="approveUser(user)"
                class="approve-btn">
                <span *ngIf="!processingUsers[user.id]">Approve</span>
                <span *ngIf="processingUsers[user.id]">Processing...</span>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- All Users Section -->
    <div class="approval-section all-users-section">
      <h3><i class="fas fa-users"></i> All System Users</h3>
      <div class="user-filters">
        <select class="role-filter" (change)="applyRoleFilter($event)">
          <option value="">All Roles</option>
          <option value="nurse">Nurse</option>
          <option value="doctor">Doctor</option>
          <option value="admin">Admin</option>
          <option value="maintenance">Maintenance</option>
        </select>
        <input type="text" placeholder="Search by name or email" class="search-filter" (input)="applySearchFilter($event)">
      </div>
      
      <!-- Display error/success messages -->
      <div class="message-container" *ngIf="error || successMessage">
        <div class="error-message" *ngIf="error">{{ error }}</div>
        <div class="success-message" *ngIf="successMessage">{{ successMessage }}</div>
      </div>
      
      <!-- Loading indicator -->
      <div class="loading-indicator" *ngIf="loading">
        <i class="fas fa-spinner fa-spin"></i> Loading users...
      </div>

      <table class="users-table all-users-table">
        <thead>
          <tr>
            <th>Username</th>
            <th>Full Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Status</th>
            <th>Last Login</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Show when no users found -->
          <tr *ngIf="getPaginatedUsers().length === 0 && !loading">
            <td colspan="7" class="text-center">No users found.</td>
          </tr>
          
          <!-- User rows -->
          <tr *ngFor="let user of getPaginatedUsers()">
            <td>{{ user.username }}</td>
            <td>{{ user.first_name }} {{ user.last_name }}</td>
            <td>{{ user.email }}</td>
            <td>{{ user.profile?.role || 'Unknown' }}</td>
            <td>
              <span [ngClass]="user.is_active ? 'status-active' : 'status-inactive'">
                {{ user.is_active ? 'Active' : 'Inactive' }}
              </span>
            </td>
            <td>{{ formatDate(user.last_login) }}</td>
            <td>
              <button class="edit-btn" (click)="editUser(user)" title="Edit user">
                <i class="fas fa-edit"></i>
              </button>
              
              <!-- Toggle active/inactive button -->
              <button *ngIf="user.is_active" class="disable-btn" (click)="prepareDeleteUser(user.id)" title="Deactivate user">
                <i class="fas fa-user-slash"></i>
              </button>
              <button *ngIf="!user.is_active" class="enable-btn" (click)="prepareDeleteUser(user.id)" title="Activate user">
                <i class="fas fa-user-check"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="pagination">
        <button class="pagination-btn" [disabled]="currentPage === 1" (click)="previousPage()">
          <i class="fas fa-chevron-left"></i>
        </button>
        <span class="page-info">Page {{ currentPage }} of {{ getTotalPages() }}</span>
        <button class="pagination-btn" [disabled]="currentPage >= getTotalPages()" (click)="nextPage()">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
      
      <!-- Edit User Modal -->
      <div class="modal" *ngIf="editingUser" [class.show]="editingUser">
        <div class="modal-content">
          <div class="modal-header">
            <h3>Edit User</h3>
            <button class="close-btn" (click)="cancelEdit()">&times;</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label>Username:</label>
              <input type="text" [(ngModel)]="editingUser.username">
            </div>
            <div class="form-group">
              <label>First Name:</label>
              <input type="text" [(ngModel)]="editingUser.first_name">
            </div>
            <div class="form-group">
              <label>Last Name:</label>
              <input type="text" [(ngModel)]="editingUser.last_name">
            </div>
            <div class="form-group">
              <label>Email:</label>
              <input type="email" [(ngModel)]="editingUser.email">
            </div>
            <div class="form-group">
              <label>Role:</label>
              <select [(ngModel)]="editingUser.profile!.role">
                <option value="nurse">Nurse</option>
                <option value="doctor">Doctor</option>
                <option value="maintenance">Maintenance</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            <div class="form-group">
              <label>Status:</label>
              <select [(ngModel)]="editingUser.is_active">
                <option [ngValue]="true">Active</option>
                <option [ngValue]="false">Inactive</option>
              </select>
            </div>
            <div class="form-group">
              <label>Password:</label>
              <input type="password" [(ngModel)]="newPassword" placeholder="Leave blank to keep unchanged">
            </div>
          </div>
          <div class="modal-footer">
            <button class="cancel-btn" (click)="cancelEdit()">Cancel</button>
            <button class="save-btn" (click)="saveUser()">Save Changes</button>
          </div>
        </div>
      </div>
      
      <!-- Delete Confirmation Modal -->
      <div class="modal" *ngIf="confirmDelete" [class.show]="confirmDelete">
        <div class="modal-content">
          <div class="modal-header">
            <h3>Confirm Action</h3>
            <button class="close-btn" (click)="cancelDelete()">&times;</button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to delete this user? This action cannot be undone.</p>
          </div>
          <div class="modal-footer">
            <button class="cancel-btn" (click)="cancelDelete()">Cancel</button>
            <button class="delete-btn" (click)="confirmDeleteUser()">Delete User</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- OR Dashboard -->
  <div class="panel-container" *ngIf="showDashboard">
    <div class="panel-header">
      <button class="back-btn" (click)="backToMainMenu()"><i class="fas fa-arrow-left"></i> Back</button>
      <h2><i class="fas fa-procedures"></i> OR Dashboard</h2>
    </div>
    
    <div class="dashboard-content">
      <p>Redirecting to OR Dashboard...</p>
      <i class="fas fa-spinner fa-spin"></i>
    </div>
  </div>
  
  <!-- Instruments Registration -->
  <div class="panel-container" *ngIf="showInstruments">
    <div class="panel-header">
      <button class="back-btn" (click)="backToMainMenu()"><i class="fas fa-arrow-left"></i> Back</button>
      <h2><i class="fas fa-briefcase-medical"></i> Asset Management</h2>
    </div>
    
    <div class="instruments-container">
      <div class="admin-options-horizontal">
        <button class="option-btn" (click)="showInstrumentRegistration()">
          <i class="fas fa-medkit"></i> Instrument Registration
        </button>
        <button class="option-btn" (click)="showLargeEquipmentRegistration()">
          <i class="fas fa-cogs"></i> Large Equipment Registration
        </button>
        <button class="option-btn" (click)="showTrayRegistration()">
          <i class="fas fa-boxes"></i> Tray Registration
        </button>
        <button class="option-btn" (click)="showReaderRegistration()">
          <i class="fas fa-rss"></i> RFID Reader Registration
        </button>
        <button class="option-btn" (click)="showOperationTypeRegistration()">
          <i class="fas fa-procedures"></i> Operation Type Registration
        </button>
      </div>
      
      <div class="instrument-registration" *ngIf="showInstrumentReg">
        <h3>RFID Instrument Registration</h3>
        <div class="scan-section">
          <button [disabled]="scanningRfid" class="scan-btn" (click)="scanForRfid()">
            <span *ngIf="!scanningRfid">Scan for RFID Tags</span>
            <span *ngIf="scanningRfid">Scanning...</span>
          </button>
        </div>
        
        <div *ngIf="rfidFound" class="registration-form">
          <!-- Display linked instrument alert when tag is linked to an instrument -->
          <div class="alert alert-warning" *ngIf="tagIsLinked && linkedAssetType === 'instrument'">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>This RFID tag is already linked to an instrument</strong>
          </div>
          <div class="form-group">
            <label>RFID Tag ID:</label>
            <input type="text" [value]="foundRfidId" readonly>
          </div>
          
          <!-- Display instrument name if linked (editable in edit mode) -->
          <div class="form-group" *ngIf="tagIsLinked && linkedAssetType === 'instrument'">
            <label>Instrument Name:</label>
            <input type="text" [(ngModel)]="newInstrumentName" [disabled]="!editMode">
          </div>
          
          <!-- Only show instrument type field when registering a new instrument (not in edit mode) -->
          <div class="form-group" *ngIf="!tagIsLinked || (tagIsLinked && !editMode)">
            <label>Instrument Type:</label>
            <select [(ngModel)]="selectedInstrumentType" [disabled]="tagIsLinked">
              <option value="">Select an instrument type</option>
              <option *ngFor="let type of instrumentTypes" [value]="type.id">{{ type.name }}</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Instrument Status:</label>
            <select [(ngModel)]="newInstrumentStatus" [disabled]="tagIsLinked && !editMode">
              <option value="available">Available</option>
              <option value="in_use">In Use</option>
              <option value="missing">Missing</option>
              <option value="under_sterilization">Under Sterilization</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Link to Tray (Optional):</label>
            <select [(ngModel)]="selectedTrayId" [disabled]="tagIsLinked && !editMode">
              <option value="">No Tray</option>
              <option *ngFor="let tray of availableTrays" [value]="tray.id">{{ tray.name }} ({{ tray.type || 'Standard' }} Tray)</option>
            </select>
          </div>
          
          <div class="form-actions" *ngIf="!tagIsLinked">
            <button class="submit-btn" (click)="saveInstrument()">Register Instrument</button>
            <button class="cancel-btn" (click)="cancelRegistration()">Cancel</button>
          </div>
          
          <div class="form-actions" *ngIf="tagIsLinked && !editMode">
            <button class="edit-btn" (click)="enableEditMode()">Edit</button>
            <button class="delete-btn" (click)="deleteInstrument()">Delete</button>
            <button class="cancel-btn" (click)="cancelRegistration()">Cancel</button>
          </div>
          
          <div class="form-actions" *ngIf="tagIsLinked && editMode">
            <button class="submit-btn" (click)="updateInstrument()">Save Changes</button>
            <button class="cancel-btn" (click)="cancelEditMode()">Cancel</button>
          </div>
        </div>
      </div>
      
      <!-- Large Equipment Registration -->
      <div class="large-equipment-registration" *ngIf="showLargeEquipmentReg">
        <h3>Large Equipment Registration</h3>
        <div class="scan-section">
          <button [disabled]="scanningRfid" class="scan-btn" (click)="scanForRfid()">
            <span *ngIf="!scanningRfid">Scan for RFID Tag</span>
            <span *ngIf="scanningRfid">Scanning...</span>
          </button>
        </div>
        
        <div *ngIf="rfidFound" class="registration-form">
          <div class="form-group">
            <label>RFID Tag ID:</label>
            <input type="text" [value]="foundRfidId" readonly>
          </div>
          
          <div class="form-group">
            <label>Equipment Name:</label>
            <input type="text" [(ngModel)]="newEquipmentName" placeholder="Enter equipment name">
          </div>
          
          <div class="form-group">
            <label>Equipment ID:</label>
            <input type="text" [(ngModel)]="newEquipmentId" placeholder="Enter unique equipment ID">
          </div>
          
          <div class="form-group">
            <label>Equipment Type:</label>
            <select [(ngModel)]="newEquipmentType">
              <option value="">Select equipment type</option>
              <option value="C-Arm">C-Arm</option>
              <option value="Microscope">Microscope</option>
              <option value="Ultrasound">Ultrasound</option>
              <option value="Ventilator">Ventilator</option>
              <option value="Other">Other</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Status:</label>
            <select [(ngModel)]="newEquipmentStatus">
              <option value="available">Available</option>
              <option value="in_use">In Use</option>
              <option value="under_repair">Under Repair</option>
              <option value="scheduled_maintenance">Scheduled Maintenance</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Notes (Optional):</label>
            <textarea [(ngModel)]="newEquipmentNotes" placeholder="Enter any additional notes"></textarea>
          </div>
          
          <div class="form-actions">
            <button class="submit-btn" (click)="saveLargeEquipment()">Register Equipment</button>
            <button class="cancel-btn" (click)="cancelRegistration()">Cancel</button>
          </div>
        </div>
      </div>
      
      <!-- Tray Registration -->
      <div class="tray-registration" *ngIf="showTrayReg">
        <h3>Tray Registration</h3>
        <div class="scan-section">
          <button [disabled]="scanningRfid" class="scan-btn" (click)="scanForRfid()">
            <span *ngIf="!scanningRfid">Scan for RFID Tag</span>
            <span *ngIf="scanningRfid">Scanning...</span>
          </button>
        </div>
        
        <div *ngIf="rfidFound" class="registration-form">
          <div class="form-group">
            <label>RFID Tag ID:</label>
            <input type="text" [value]="foundRfidId" readonly>
          </div>
          
          <div class="form-group">
            <label>Tray Type:</label>
            <select [(ngModel)]="newTrayType">
              <option value="">Select tray type</option>
              <option value="General">General</option>
              <option value="Orthopedic">Orthopedic</option>
              <option value="Neurological">Neurological</option>
              <option value="Cardiac">Cardiac</option>
              <option value="Other">Other</option>
            </select>
          </div>
          
          <div class="form-actions">
            <button class="submit-btn" (click)="saveTray()">Register Tray</button>
            <button class="cancel-btn" (click)="cancelRegistration()">Cancel</button>
          </div>
        </div>
      </div>
      
      <!-- RFID Reader Registration -->
    <div class="registration-panel" *ngIf="showReaderReg">
      <h2><i class="fas fa-rss"></i> RFID Reader Registration</h2>
      
      <div class="registration-form">
        <div class="form-row">
          <div class="form-group">
            <label for="port">Port</label>
            <select id="port" [(ngModel)]="selectedPort" required>
              <option value="">Select Port</option>
              <option *ngFor="let port of availablePorts" [value]="port">{{port}}</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="location">Location</label>
            <select id="location" [(ngModel)]="selectedLocation" required>
              <option value="">Select Location</option>
              <option *ngFor="let location of availableLocations" [value]="location">{{location}}</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="baudrate">Baud Rate</label>
            <select id="baudrate" [(ngModel)]="selectedBaudRate" required>
              <option [ngValue]="null">Select Baud Rate</option>
              <option *ngFor="let rate of baudRates" [ngValue]="rate">{{rate}}</option>
            </select>
          </div>
        </div>
        
        <div class="form-actions">
          <button class="submit-btn" [disabled]="!selectedPort || !selectedLocation || !selectedBaudRate">
            <i class="fas fa-save"></i> Register Reader
          </button>
          <button class="cancel-btn" (click)="cancelRegistration()">
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
      </div>
    </div>
      
      <!-- Operation Type Registration Form -->
    <div class="registration-panel" *ngIf="showOperationTypeReg">
      <h2><i class="fas fa-procedures"></i> Operation Type Registration</h2>
      
      <div class="registration-form">
        <div class="form-group">
          <label for="operationType">Operation Type</label>
          <select id="operationType" [(ngModel)]="selectedOperationType" required>
            <option value="">Select Operation Type</option>
            <option *ngFor="let opType of operationTypes" [value]="opType">{{opType}}</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Required Instruments</label>
          <div class="instruments-grid">
            <div class="instrument-row" *ngFor="let instrument of availableInstruments">
              <div class="instrument-check">
                <input type="checkbox" [id]="'instrument-' + instrument.id" (change)="handleInstrumentSelection($event, instrument)">
                <label [for]="'instrument-' + instrument.id">{{instrument.name}}</label>
              </div>
              <div class="quantity-controls" *ngIf="isInstrumentSelected(instrument.id)">
                <button type="button" (click)="decrementQuantity(instrument.id)">-</button>
                <input type="number" min="1" [value]="getInstrumentQuantity(instrument.id)" (input)="handleQuantityChange($event, instrument.id)">
                <button type="button" (click)="incrementQuantity(instrument.id)">+</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="form-group selected-summary" *ngIf="selectedInstruments.length > 0">
          <label>Selected Instruments</label>
          <ul class="selected-items">
            <li *ngFor="let instrument of selectedInstruments">
              {{instrument.name}} Ã— {{instrument.quantity}}
            </li>
          </ul>
        </div>
        
        <div class="form-actions">
          <button class="submit-btn" [disabled]="!selectedOperationType || selectedInstruments.length === 0">
            <i class="fas fa-save"></i> Register Operation Type
          </button>
          <button class="cancel-btn" (click)="cancelRegistration()">
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
      </div>
    </div>
    </div>
  </div>

  <!-- System Logs Panel -->
  <div class="panel-container" *ngIf="showLogs">
    <div class="panel-header">
      <button class="back-btn" (click)="backToMainMenu()"><i class="fas fa-arrow-left"></i> Back</button>
      <h2><i class="fas fa-clipboard-list"></i> System Logs</h2>
    </div>
    
    <div class="logs-container">
      <div class="tabs">
        <button class="tab-btn active" (click)="selectLogType('verification')">Verification Logs</button>
        <button class="tab-btn" (click)="selectLogType('outbound')">Outbound Logs</button>
        <button class="tab-btn" (click)="selectLogType('system')">System Activity</button>
      </div>
      
      <div class="log-filters">
        <div class="filter-group">
          <label>Date Range:</label>
          <select>
            <option value="today">Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="week">Last 7 Days</option>
            <option value="month">Last 30 Days</option>
            <option value="custom">Custom Range</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label>Filter:</label>
          <input type="text" placeholder="Search logs...">
        </div>
      </div>
      
      <div class="log-table-container">
        <table class="log-table">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>User</th>
              <th>Action</th>
              <th>Details</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>2025-07-07 02:45:12</td>
              <td>dr.smith</td>
              <td>Instrument Verification</td>
              <td>Surgery #1245 - Hip Replacement</td>
              <td><span class="status-complete">Complete</span></td>
            </tr>
            <tr>
              <td>2025-07-07 02:30:05</td>
              <td>nurse.jones</td>
              <td>Equipment Check-out</td>
              <td>Cardiac Monitor #CM-2234</td>
              <td><span class="status-complete">Complete</span></td>
            </tr>
            <tr>
              <td>2025-07-07 02:15:33</td>
              <td>tech.williams</td>
              <td>Maintenance</td>
              <td>Scheduled service - Ventilator #V-9872</td>
              <td><span class="status-pending">Pending</span></td>
            </tr>
            <tr>
              <td>2025-07-07 01:55:18</td>
              <td>dr.johnson</td>
              <td>Tray Verification</td>
              <td>Surgery #1244 - Appendectomy</td>
              <td><span class="status-issue">Missing Items</span></td>
            </tr>
            <tr>
              <td>2025-07-07 01:42:09</td>
              <td>nurse.thompson</td>
              <td>Equipment Return</td>
              <td>Infusion Pump #IP-4421</td>
              <td><span class="status-complete">Complete</span></td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div class="pagination">
        <button disabled><i class="fas fa-chevron-left"></i></button>
        <span>Page 1 of 5</span>
        <button><i class="fas fa-chevron-right"></i></button>
      </div>
    </div>
  </div>
</div>

<!-- System Logs is now a standalone page --> 
